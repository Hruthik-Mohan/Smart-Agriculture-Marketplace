<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login / Register - AgroConnect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <nav class="navbar navbar-light bg-white shadow-sm">
      <div class="container"><a class="navbar-brand" href="/">AgroConnect</a></div>
    </nav>

    <main class="container py-5">
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="card-title">Register</h3>
              <form id="registerForm">
                <div class="mb-2"><input class="form-control" placeholder="Name" name="name" required /></div>
                <div class="mb-2"><input class="form-control" placeholder="Email" name="email" type="email" /></div>
                <div class="mb-2"><input class="form-control" placeholder="Phone" name="phone" /></div>
                <div class="mb-2"><input class="form-control" placeholder="Location" name="location" /></div>
                <div class="mb-2"><select class="form-select" name="role"><option value="farmer">Farmer</option><option value="buyer">Buyer</option></select></div>
                <div class="mb-3"><input class="form-control" placeholder="Password" name="password" type="password" required /></div>
                <button class="btn btn-success">Register</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="card-title">Login</h3>
              <form id="loginForm">
                <div class="mb-2"><input class="form-control" placeholder="Email or Phone" name="emailOrPhone" required /></div>
                <div class="mb-3"><input class="form-control" placeholder="Password" name="password" type="password" required /></div>
                <button class="btn btn-primary">Login</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const api = '/api';

      document.getElementById('registerForm').onsubmit = async e=>{
        e.preventDefault();
        const f = e.target;
        const body = {name:f.name.value,email:f.email.value,phone:f.phone.value,location:f.location.value,role:f.role.value,password:f.password.value};
        const res = await fetch(api+'/auth/register',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
        const data = await res.json();
        if(res.ok){
          // register returns token and user
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          
          // Show verification message if email was provided
          if(data.msg && data.msg.includes('verify')) {
            alert('âœ… Registration Successful!\n\n' + data.msg + '\n\nIn development mode, check your server console for the verification link.');
          }
          
          if(data.user.role==='farmer') location.href='/farmer.html'; else location.href='/buyer.html';
        } else alert(data.msg || JSON.stringify(data));
      }

      document.getElementById('loginForm').onsubmit = async e=>{
        e.preventDefault();
        const f = e.target;
        const body = {emailOrPhone:f.emailOrPhone.value,password:f.password.value};
        const res = await fetch(api+'/auth/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
        const data = await res.json();
        if(res.ok){
          // store token + user
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          if(data.user.role==='farmer') location.href='/farmer.html'; else location.href='/buyer.html';
        } else alert(data.msg || JSON.stringify(data));
      }
    </script>
  </body>
</html>
